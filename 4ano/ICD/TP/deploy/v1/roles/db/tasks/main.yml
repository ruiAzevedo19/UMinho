---  
- name: Install and configure PostgreSQL    
  apt:
    name: "{{ item }}"
    update_cache: yes
    state: present
  loop: "{{ db_packages }}"

- name: Configure PostgreSQL. Set listen_addresses.
  lineinfile: dest=/etc/postgresql/{{ postgresql_version }}/main/postgresql.conf
    regexp="listen_addresses =" line="listen_addresses = '*'" state=present
  notify: restart postgresql

- name: Configure allowed hosts.
  lineinfile:
    path: /etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf
    line: host all all 0.0.0.0/0 trust
    create: yes

- name: Install psycopg2
  pip: name=psycopg2

- name: Ensure Wiki.js database is created
  become: true
  become_user: postgres
  postgresql_db: 
    name: '{{ wikijs_db_name }}'
    encoding: 'UTF-8'
    lc_collate: 'en_US.UTF-8'
    lc_ctype: 'en_US.UTF-8'
    template: 'template0'
    state: present  
    
- name: Ensure user has access to the database
  become: true
  become_user: postgres
  postgresql_user:
    db: '{{ wikijs_db_name }}'
    name: '{{  wikijs_db_user }}'
    password: '{{ wikijs_db_password }}'
    priv: ALL
    state: present